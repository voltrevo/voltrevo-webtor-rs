name: Fuzz Testing

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Fuzz duration in seconds (default: 18000 = 5 hours)'
        required: false
        default: '18000'
      target:
        description: 'Fuzz target (all, fuzz_certificate, fuzz_server_hello, fuzz_handshake_parse, fuzz_record)'
        required: false
        default: 'all'

env:
  CARGO_TERM_COLOR: always

jobs:
  fuzz:
    name: Fuzz ${{ github.event.inputs.target || 'all' }}
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@nightly

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          crates/subtle-tls/fuzz/target/
          crates/subtle-tls/fuzz/corpus/
        key: ${{ runner.os }}-fuzz-${{ hashFiles('**/Cargo.lock') }}

    - name: Run fuzz tests
      working-directory: crates/subtle-tls/fuzz
      run: |
        DURATION=${{ github.event.inputs.duration || '18000' }}
        TARGET=${{ github.event.inputs.target || 'all' }}
        PER_TARGET_DURATION=$((DURATION / 4))
        
        echo "Total duration: ${DURATION}s"
        echo "Target: ${TARGET}"
        
        if [ "$TARGET" = "all" ]; then
          echo "Running all fuzz targets for ${PER_TARGET_DURATION}s each..."
          
          for target in fuzz_certificate fuzz_server_hello fuzz_handshake_parse fuzz_record; do
            echo ""
            echo "=========================================="
            echo "Fuzzing: $target"
            echo "=========================================="
            cargo +nightly fuzz run $target -- -max_total_time=$PER_TARGET_DURATION || true
          done
        else
          echo "Running $TARGET for ${DURATION}s..."
          cargo +nightly fuzz run $TARGET -- -max_total_time=$DURATION
        fi

    - name: Upload crash artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: fuzz-crashes
        path: crates/subtle-tls/fuzz/artifacts/
        if-no-files-found: ignore

    - name: Upload corpus
      uses: actions/upload-artifact@v4
      with:
        name: fuzz-corpus
        path: crates/subtle-tls/fuzz/corpus/
        if-no-files-found: ignore
